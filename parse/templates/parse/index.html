{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dashboard</title>

    <!-- Bootstrap Core CSS -->
    <link href="{% static 'parse/css/bootstrap.min.css' %}"        rel="stylesheet">
    
    <!-- Date Picker   -->
    <link href="{% static 'parse/css/bootstrap-datepicker.css' %}" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{% static 'parse/css/js-custom.css' %}" rel="stylesheet">
    <!-- <link href="{% static 'parse/css/sb-admin.css' %}" rel="stylesheet"> -->
    
    <!-- Custom Fonts -->
    <link href="{% static 'parse/font-awesome/css/font-awesome.min.css' %}" rel="stylesheet" type="text/css">

    <link href="{% static 'parse/css/spinner.css' %}" rel="stylesheet" type="text/css">
    
    <!-- jQuery -->
    <script src="{% static 'parse/js/jquery.js' %}"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="{% static 'parse/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'parse/js/bootstrap-datepicker.js' %}"></script>
    <script src="{% static 'parse/locales/bootstrap-datepicker.ko.min.js' %}"></script>

    <!-- Chart lib-->
    <script src="{% static 'parse/js/chartNew.js' %}"></script>
    <script src="{% static 'parse/js/bootstrap_ChartNew.js' %}"></script>
    
    <!-- Chart Setting -->
    <script src="{% static 'parse/js/chartNew_setting.js' %}"></script>
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
   
    <script>
       
    </script>
</head>

<body> 
<div class="spinner-loader" style="position:fixed; top:50%; left:50%; z-index:999;">Loading…</div>
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header">
            <!--font color-->
          <a class="navbar-brand" href="#">Statistics Overview</a>
        </div>
        <div>
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <!-- <li><a href="#">Page 1</a></li>-->
          </ul>
        </div>
      </div>
    </nav>
    
    <div class="container-fluid">
        <!-- Page Heading 
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">
                     <small>Statistics Overview</small>
                </h1>
                <ol class="breadcrumb">
                    <li class="active">
                        <i class="fa fa-dashboard"></i> Dashboard
                    </li>
                </ol>
            </div>
        </div>
        <!-- /.row -->
    
        <!--
        <div class="row">
            <div class="col-lg-12">
                <div class="alert alert-info alert-dismissable">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                    <i class="fa fa-info-circle"></i>  <strong>Like SB Admin?</strong> Try out <a href="http://startbootstrap.com/template-overviews/sb-admin-2" class="alert-link">SB Admin 2</a> for additional features!
                </div>
            </div>
        </div>
        <!-- /.row -->
    
        <div class="row">
            <div class="col-lg-4 col-md-4">
                <div class="col-lg-8 col-lg-offset-2">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                               
                                <div class="col-xs-2">
                                    <i class="fa fa-comments fa-5x"></i>
                                </div>
                                <div class="col-xs-10 text-right">
                                    <div class="huge">26 w</div>
                                    <div>현재 총사용 전력</div>
                                </div>
                            </div>
                        </div>
                        <!-- remove 
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                        -->
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-4">
                <div class="col-lg-8 col-lg-offset-2">
                    <div class="panel panel-green">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-2">
                                    <i class="fa fa-tasks fa-5x"></i>
                                </div>
                                <div class="col-xs-10 text-right">
                                    <div class="huge">12 kWh</div>
                                    <div>당월 예상 전력량</div>
                                </div>
                            </div>
                        </div>
                        <!-- remove
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-left">View Details</span>
                                <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                        -->
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-4">
                <div class="col-lg-8 col-lg-offset-2">
                <div class="panel panel-yellow">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-2">
                                <i class="fa fa-shopping-cart fa-5x"></i>
                            </div>
                            <div class="col-xs-10 text-right">
                                <div class="huge">124 won</div>
                                <div>당월 예상 전기세</div>
                            </div>
                        </div>
                    </div>
                    <!-- remove
                    <a href="#">
                        <div class="panel-footer">
                            <span class="pull-left">View Details</span>
                            <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                            <div class="clearfix"></div>
                        </div>
                    </a>
                    -->
                </div>
            </div>
            </div>
        </div>
        <!-- /.row -->
        
        
        <!-- test-->
    <div class="row">
        <div class="col-lg-6"> <!-- 12 -> 6-->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-bar-chart-o fa-fw"></i> 기간별 전력 사용량</h3>
                </div>
                <div class="panel-body ">
                <div class="row">
            		<div class="col-md-12">
            			<nav class="navbar navbar-default" role="navigation">
            				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            					<ul class="nav navbar-nav">
            						<li class="active">
            							<a data-toggle="tab" href="#day">Day</a>
            						</li>
            						<li>
            							<a data-toggle="tab" href="#week">Week</a>
            						</li>
            					</ul>
            					
            					<ul class="nav navbar-nav navbar-right">
            					    <li>
            					       <form class="navbar-form" role="search">
                		                    <div class="pull-right input-group input-append date" id="periodDatePicker">
                			                    <input type="text" class="form-control" placeholder="picker test..." id="dateInput" disabled>
                			                    <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                		                    </div>
                		              </form>
                		            </li>
            						<li class="dropdown">
            							<a href="#" class="dropdown-toggle" data-toggle="dropdown" id="periodDropdown-toggle" >Choose Device<strong class="caret"></strong></a>
            							<ul class="dropdown-menu" id="periodDropdown-menu">
            							    <li><a href="#dev1" id="dev1">Device #1</a></li>
                                            <li><a href="#dev2" id="dev2">Device #2</a></li>
                                            <li><a href="#dev3" id="dev3">Device #3</a></li>
            							</ul>
            						</li>
            					</ul>
            				</div>
            			</nav>
            		</div>
            	</div>	<!--row-->
	
	
                <!-- nav nav-tabs -->
                                        
                <div class="tab-content">
                    <div id="home" class="tab-pane fade in active">
                    </div>
                    <div id="menu1" class="tab-pane fade">
                    </div>
                </div>
                            
                   <div id = "chart-container" >
                       <canvas id="periodCanvas"></canvas>
                       <script> 
                            // var myChart = setCanvas("Line",dataForDay,dayChartOptions);
                            // setCanvas("Line",dataForDay,dayChartOptions);
                            // new Chart(document.getElementById("_Tag_Canvas_0").getContext("2d")).Line(dataForWeek,weekChartOptions);
                            console.log("canvas is drawn");
                            var periodChart =  new Chart(document.getElementById("periodCanvas").getContext("2d")).Line(dayChartData,dayChartOptions);
                       </script>
                   </div>
                </div>
            </div>
        </div>
                
        <!--update chart-->
        <div class="col-lg-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="fa fa-bar-chart-o fa-fw"></i> 분당 전력 사용량</h3>
                </div>
                <div class="panel-body">
                     <div class="row">
                		<div class="col-md-12">
                			<nav class="navbar navbar-default" role="navigation">
                				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                					<ul class="nav navbar-nav navbar-right">
                					   
                						<li class="dropdown pull-right">
                							 <a class="dropdown-toggle" href="#" data-toggle="dropdown" id="currentDropdown-toggle">Choose Device<strong class="caret"></strong></a>
                                            <ul class="dropdown-menu" id="currentDropdown-menu">
                                                <li><a href="#all">All Devices</a></li>
                                                <li class="divider"></li>
                                                <li><a href="#dev1" id="dev1">Device #1</a></li>
                                                <li><a href="#dev2" id="dev2">Device #2</a></li>
                                                <li><a href="#dev3" id="dev3">Device #3</a></li>
                                            </ul>
                						</li>
                					</ul>
                				</div>
                			</nav>
                		</div>
                	</div>	<!--row-->
                    <div id = "chart-container" >
                        <canvas id="currentCanvas"></canvas>
                        <script> 
                            // var myChart = setCanvas("Line",dataForDay,dayChartOptions);
                            // setCanvas("Line",dataForDay,dayChartOptions);
                            // new Chart(document.getElementById("_Tag_Canvas_0").getContext("2d")).Line(dataForWeek,weekChartOptions);
                            
                            console.log("currentChart - canvas is drawn");
                            var currentChart =  new Chart(document.getElementById("currentCanvas").getContext("2d")).Line(updateChartData,updateChartOptions);
                        </script>
                    </div>
            </div>
        </div>
    </div>
    <!--update chart-->
    </div>
        <!-- /.row -->
    
        <div class="row">
            <div class="col-lg-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><i class="fa fa-long-arrow-right fa-fw"></i> Doughnut Chart</h3>
                    </div>
                    <div class="panel-body">
                        <!-- div id="morris-donut-chart"></div>-->
                        <div id="chart-container">
                            <div>
                                <canvas id = "doughnut-canvas"></canvas>
                                <script>
                                    var doughnutChart = new Chart(document.getElementById("doughnut-canvas").getContext("2d")).Doughnut(doughnutChartData,doughnutChartOptions);
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><i class="fa fa-money fa-fw"></i>스위치 정보</h3>
                    </div>
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>Switch Name</th>
                                        <th>Today use time</th>
                                        <th>Daily avg. <br> use time</th>
                                        <th>Current electric <br> power (w)</th>
                                        <th>Avg. electric <br> power (w)</th>
                                        <th>Expected monthly <br> electric energy</th>
                                        <th>Expected monthly <br> bill (won)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Bed Room</td>
                                        <td></td>
                                        <td></td>
                                        <td>50</td>
                                        <td>150</td>
                                        <td>3h 3m</td>
                                        <td>321.33</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.row -->    
    </div>
    <!-- /.container-fluid -->
    <!--<script src="{% static 'parse/js/periodChart.js' %}"></script>-->
    <script>
    //group id
    var groupId = '{{ Data.groupId }}';
    
    var selectedDate = "20151104";
    var endPoint     = "dailyUsage";
    var deviceName   = "";
    
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var tabName = $(e.target).attr("href"); // activated tab
        
        /*
        if(myChart == null) {
            console.log("chart is null");
        } else {
           // $('#canvas').remove();
           // $('#chart-container').append('<canvas id = canvas></canvas>');
        }
        */
        
        var canvas = document.getElementById("periodCanvas");
        // canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);
        // canvas.getContext("2d").beginPath();
        console.log("cv : " + canvas ); 
        
        if(tabName == '#day') {
            updateChart(canvas.getContext("2d"),dayChartData,dayChartOptions);
            // new Chart(canvas.getContext("2d")).Line(dataForDay,dayChartOptions);   
            endPoint = "dailyUsage";
        } else {
            updateChart(canvas.getContext("2d"),weekChartData,weekChartOptions);
            //new Chart(canvas.getContext("2d")).Line(dataForWeek,weekChartOptions);
            endPoint = "weeklyUsage";
        }
        
        console.log("tabName : " + tabName + ", endPoint : " + endPoint);
        requestData();
    });
    
    function getPeriodDeviceId(e) {
        var target = $(e.target).attr("href");
        //$(".dropdown-toggle").text($(e.target).text());
        $("#periodDropdown-toggle").text($(e.target).text());
        
        deviceName =  $(e.target).text();
        
        requestData();
    }
    
    function getCurrentDeviceId(e) {
        var target = $(e.target).attr("href");
        // $("#periodDropdown-toggle").text($(e.target).text());
        $("#currentDropdown-toggle").text($(e.target).text());
        
        deviceName =  $(e.target).text();
        
         //arr 초기화
            for(var i = 0; i < updateChartData.labels.length; i++) {
                console.log("i : "+ updateChartData.labels[i]);
                updateChartData.labels[i] = "-";
                updateChartData.datasets[0].data[i] = 0;                    
            }
            
        requestIntervalData();
    }
    
    function getToday() {
        var today = new Date();
        today =  today.toISOString().slice(0,10).replace(/-/g,"");
        
        return today;
    }
    
     function getLastDayOfWeek(date) {
        console.log("getLastDayOfWeek() date -  "+ date);
        var cur = new Date();
        
        cur.setYear(Number(date.toString().substring(0,4)) + 1900);
        cur.setMonth(Number(date.toString().substring(4,6)) - 1);
        cur.setDate(Number(date.toString().substring(6,8)));
        
        var firstDay = cur.getDate() - cur.getDay();
        var lastDay = firstDay + 8;
        
        var result = cur.getYear();
        if(cur.getMonth() < 10) {
            result = result + '0'+ (cur.getMonth() + 1);
        } else {
            result = result + '' + (cur.getMonth() + 1);
        }
        
        if(lastDay < 10) {
            result = result + '0'+ lastDay;
        } else {
            result = result + '' + lastDay;
        }
        
        return result;
    }
    
    function setTable() {
        
    }
    
    function getUrl() {
        selectedDate = $("input:text").val();  
        console.log("endPoint : " + endPoint + ", selectedDate : " + selectedDate + ", deviceName :" + deviceName);
    
        var url;
        
        if(endPoint== "dailyUsage") {
            // url = 'https://parse-test-jisungkim.c9users.io/' + endPoint + '?format=json&date='+selectedDate+'&deviceId='+deviceName;    
            url = "{% url 'restDailyUsage' %}" + '?format=json&date='+selectedDate+'&deviceId='+deviceName;    
        } else {
            // url = 'https://parse-test-jisungkim.c9users.io/' + endPoint + '?format=json&date='+ getToday()+'&targetDate='+getLastDayOfWeek(selectedDate)+'&deviceId='+deviceName;    
            url = "{% url 'restWeeklyUsage' %}" + '?format=json&date='+ getToday()+'&targetDate='+getLastDayOfWeek(selectedDate)+'&deviceId='+deviceName;    
        }
        
        return url;
    }
    
    var diff = 10000;
    function intCeil(num) {
        return Math.ceil((num/diff)) * diff;
    }
    
    function getDeviceList() {
        var url = "{% url 'restDeviceList' %}";
        
        jQuery.ajax({
            url : url,
            method: 'GET'
        }).then(function(data) {
            var list="";
            for(var i = 0; i< data.length; i++) {
                console.log("dev : " + data[i]);
                list = list+ " <li><a href='#dev"+(i+1)+"' id='dev"+ (i+1)+"'>"+data[i]+"</a></li>";
            }
            
            document.getElementById('periodDropdown-menu').innerHTML =list;
            document.getElementById('currentDropdown-menu').innerHTML =list;
            
            deviceName = data[0];
            
            $(".dropdown-toggle").text(deviceName);
            //$("#periodDropdown-toggle").text(deviceName);
            //$("#currentDropdown-toggle").text(deviceName);
            
            requestData();
            requestIntervalData();
            
            setInterval(function() {requestIntervalData();},60000);
        });
    }
    
    function requestIntervalData() {
        var url = "{% url 'restCurrentUsage' %}" + '?format=json&deviceId='+deviceName;
        
        console.log("requestIntervalData() url : "+ url);
        
        jQuery.ajax({
            url :  url,
            method: 'GET'
        }).then(function(data) {
            console.log(data);
            
            var idx = updateChartData.labels.length;
            var label;
            
            if(data.time.toString().length == 3) {
                label = data.time.toString().substring(0,1) +":"+data.time.toString().substring(1,3);
            } else {
                label = data.time.toString().substring(0,2) +":"+data.time.toString().substring(2,4);
            }
            
            updateChartData.labels[idx] = label;
            updateChartData.datasets[0].data[idx] = data.value;
            updateChartData.labels.splice(0,1);
            updateChartData.datasets[0].data.splice(0,1);
            
            updateChart(document.getElementById("currentCanvas").getContext("2d"), updateChartData, updateChartOptions, true, true);
        });
    }
    
    function requestData() {
        var url = getUrl();
        console.log("requestData() url : " + url);
        
        $('.spinner-loader').show();
        jQuery.ajax({
            url : url,
            method: 'GET'
        }).then(function(data) {
            if(endPoint == "dailyUsage") {
                for(var i = 0; i<Object.keys(data).length;i++) {
                    dayChartData.datasets[0].data[i] = data[i];
                }
                
                //console.log("min : " + Math.max.apply(null,dayChartData.datasets[0].data));
                //console.log("ceil : " + Math.pow(Math.max.apply(null,dataForDay.datasets[0].data),100));
                //console.log("ceil : " + intCeil(Math.max.apply(null,dayChartData.datasets[0].data)));
                var minCeil =  intCeil(Math.min.apply(null,dayChartData.datasets[0].data));
                var maxCeil =  intCeil(Math.max.apply(null,dayChartData.datasets[0].data));
                
                dayChartOptions.scaleStepWidth = Math.round((maxCeil - minCeil) / 10) + diff;
                //dayChartOptions.scaleStartValue = Math.min.apply(null,dataForDay.datasets[0].data);
                //console.log("minCeil : " + minCeil);
                
                if(minCeil <= 0) {
                    dayChartOptions.scaleStartValue = minCeil;
                } else {
                    dayChartOptions.scaleStartValue = minCeil-diff;
                }
                
                updateChart(document.getElementById("periodCanvas").getContext("2d"), dayChartData, dayChartOptions, true, true);
            } else {
                for(var i = 0; i <= Object.keys(Object.keys(data)[0]).length;i++) {
                    weekChartData.datasets[0].data[i] = data.current[i];
                    weekChartData.datasets[1].data[i] = data.target[i];
                }
                
                updateChart(document.getElementById("periodCanvas").getContext("2d"), weekChartData, weekChartOptions, true, true);
            }
             $('.spinner-loader').hide();
        });
    }
    
    $("#periodDropdown-menu").on("click","li",getPeriodDeviceId);
    $("#currentDropdown-menu").on("click","li",getCurrentDeviceId);
    
    $(document).ready(function () {
        getDeviceList();
        
        var today = getToday();
        
        $('#periodDatePicker').datepicker({
            format: "yyyymmdd",
            todayHighlight:true,
            autoclose:true
        });  
        
        $('#periodDatePicker').datepicker("setDate", today);
        
        $('#updateDatePicker').datepicker({
            format: "yyyymmdd",
            todayHighlight:true,
            autoclose:true
        });  
        
        $('#updateDatePicker').datepicker("setDate", today);
        
        $('#periodDatePicker').change(function() {
           requestData();
        });
        
        $('#updateDatePicker').change(function() {
           requestIntervalData();
        });
        
    });
    //setRefreshCanvas();
    </script>
</body>

</html>